<!doctype html>
<html>
<head>
	<title>Demo </title>
	<style>
	body { 
		width: max-content; 
		width: -moz-max-content;
		width: -webkit-max-content;
	}
	.grid {
		display: inline-block;
	}
	.row {
		margin: 0;
		height: 7px;
	}
	.cell {
		border-top: 7px solid #ddd;
		width: 7px;
		display: inline-block;
		vertical-align: top;
	}
	</style>
	<script src = "https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type = "text/javascript"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.6/xlsx.full.min.js"></script>
	<script>
	
	</script>
</head>
<body>
<div>
	<input type="button" id="viewfile" value="Export To Table" onclick="ExportToTable()" />
</div>
<div class="grid"></div>
	<script src = "plugins/grid.js"></script>

<script src="plugins/xlsx/dist/cpexcel.js"></script>
<script src="plugins/xlsx/shim.js"></script>
<script src="plugins/xlsx/jszip.js"></script>
<script src="plugins/xlsx/xlsx.js"></script>

<script>
/*jshint browser:true */
/* eslint-env browser */
/*global Uint8Array, console */
/*global XLSX */
var X = XLSX;
var XW = {
	/* worker message */
	msg: 'xlsx',
	/* worker scripts */
	worker: './xlsxworker.js'
};

var global_wb;

var global_grid;
function render_grid(rownum, colnum) {
    var grid = new Grid({
        rows: rownum,
        cols: colnum,
        render: {
            placeholder: ".grid"
        }
    });
    <!-- grid.getCellAt(2, 1).$el.css('background', 'red'); -->
	global_grid = grid;
};

var process_wb = (function() {
	var to_json = function to_json(workbook) {
		var result = {};
		workbook.SheetNames.forEach(function(sheetName) {
			var roa = X.utils.sheet_to_json(workbook.Sheets[sheetName], {header:1});
			if(roa.length) result = roa;
		});
		return result;
	};

	return function process_wb(wb) {
		global_wb = wb;
		var output = "";
		output = to_json(wb);
		draw_grid(output);
	};
})();

function draw_grid(route) {
	console.log(route);
	var latArray = route.map(function(elt) {return elt[0]; });
	var latMax = Math.max.apply(null, latArray);
	var latMin = Math.min.apply(null, latArray);
	
	var lngArray = route.map(function(elt) {return elt[1]; });
	var lngMax = Math.max.apply(null, lngArray);
	var lngMin = Math.min.apply(null, lngArray);
	
	var grid_num_row = lngMax - lngMin + 50;
	var grid_num_col = latMax - latMin + 50;
	render_grid(grid_num_row, grid_num_col);
	
	console.log(latMax, latMin, lngMax, lngMin);
	<!-- global_grid.getCellAt(3, 3).$el.css('border-top', '7px solid #000'); -->
	for (var x=25; x < latMax-latMin+25; x++)
		for (var y = 25; y < lngMax-lngMin+25; y++)
			global_grid.getCellAt(x, y).$el.css('border-top', '7px solid #5da1e6'); 
}
var setfmt = window.setfmt = function setfmt() { if(global_wb) process_wb(global_wb); };

var b64it = window.b64it = (function() {
	var tarea = document.getElementById('b64data');
	return function b64it() {
		if(typeof console !== 'undefined') console.log("onload", new Date());
		var wb = X.read(tarea.value, {type:'base64', WTF:false});
		process_wb(wb);
	};
})();

var do_file_ = (function() {
	var use_worker = typeof Worker !== 'undefined';
	var xw = function xw(data, cb) {
		var worker = new Worker(XW.worker);
		worker.onmessage = function(e) {
			switch(e.data.t) {
				case 'ready': break;
				case 'e': console.error(e.data.d); break;
				case XW.msg: cb(JSON.parse(e.data.d)); break;
			}
		};
		worker.postMessage({d:data,b:rABS?'binary':'array'});
	};

	return function do_file_(file) {
		rABS = true;
		var f = file;
		var reader = new FileReader();
		reader.onload = function(e) {
			if(typeof console !== 'undefined') console.log("onload", new Date());
			var data = e.target.result;
			process_wb(X.read(data, {type: rABS ? 'binary' : 'array'}));
		};
		reader.readAsBinaryString(f);
	};
})();

function ExportToTable() {
	var request = new XMLHttpRequest();

	request.responseType = "blob";
	request.onreadystatechange = (e) => {
		if (request.readyState !== 4) {
			return;
		}
		if (request.status === 200) {
			console.log('success', request);
		} else {
			console.warn('error');
		}
	};

	request.onload = function(oEvent) {
		var blob = request.response;
		// ...
		<!-- do_file_(blob); -->
		var reader = new FileReader();
		reader.onload = function(e) {
			if(typeof console !== 'undefined') console.log("onload", new Date());
			var data = e.target.result;
			process_wb(X.read(data, {type: 'binary'}));
		};
		reader.readAsBinaryString(blob);
	};
	request.open('GET', "data/JourneyCell40/51B02517.xlsx");
	request.send();
};

</script>
<script type="text/javascript">
/* eslint no-use-before-define:0 */
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-36810333-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body>
</html>
